<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chi ti·∫øt ng∆∞·ªùi n·ªïi ti·∫øng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen text-gray-800 bg-[url('./bg-soft.png')] bg-cover bg-center bg-fixed bg-no-repeat">
  <div class="container mx-auto px-4 py-12">
    <a href="index.html" class="text-purple-700 font-semibold hover:underline">&larr; Quay l·∫°i Trang Ch·ªß</a>
    <div id="celeb-detail" class="mt-8 animate-slide-in"></div>
  </div>

  <script>
    const BASE_URL = window.location.origin;

    async function loadDetail() {
      const celebId = new URLSearchParams(window.location.search).get('id');
      const detailContainer = document.getElementById('celeb-detail');
      const token = localStorage.getItem('token');

      const [celebRes, meRes] = await Promise.all([
        fetch(`${BASE_URL}/api/celebs`),
        token
          ? fetch(`${BASE_URL}/api/users/me`, {
              headers: { Authorization: 'Bearer ' + token }
            }).then(r => r.ok ? r.json() : { ratings: [] })
          : Promise.resolve({ ratings: [] })
      ]);

      const celebs = await celebRes.json();
      const userRatings = meRes.ratings || [];
      const celeb = celebs.find(c => c._id === celebId);
      const ratedCeleb = userRatings.find(r => r.celeb === celebId);

      if (!celeb) {
        detailContainer.innerHTML = '<p class="text-red-500">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi n·ªïi ti·∫øng.</p>';
        return;
      }

      const average = celeb.ratingCount > 0 ? (celeb.totalRating / celeb.ratingCount) : 0;
      const ratingStars = [1, 2, 3, 4, 5].map(i => {
        if (ratedCeleb) {
          return `<span data-value="${i}" class="star text-2xl ${i <= ratedCeleb.value ? 'text-yellow-400' : 'text-gray-400'}">‚òÖ</span>`;
        } else {
          return `<span data-value="${i}" class="star cursor-pointer text-2xl text-gray-500 hover:text-yellow-400 transition-all">‚òÜ</span>`;
        }
      }).join('');

      detailContainer.innerHTML = `
        <div class="flex flex-col md:flex-row gap-8 backdrop-blur-sm bg-white/30 p-6 rounded-lg shadow-lg">
          <div class="md:w-1/3 w-full flex flex-col items-center">
            <img src="${celeb.image}" class="w-full rounded object-cover max-h-[500px]" alt="${celeb.name}" />
            <div id="rating-stars" class="mt-4 flex gap-1">${ratingStars}</div>
            <div id="fav-btn-container" class="mt-4"></div>
          </div>
          <div class="flex-1">
            <h1 class="text-3xl font-bold text-purple-800 mb-2">${celeb.name}</h1>
            <p class="text-lg font-medium text-gray-600 mb-4">${Array.isArray(celeb.profession) ? celeb.profession.join(', ') : celeb.profession}</p>
            <p class="text-gray-700 leading-relaxed whitespace-pre-line">${celeb.description}</p>
          </div>
        </div>
      `;

      // ƒê√°nh gi√° sao
      if (!ratedCeleb) {
        document.querySelectorAll('.star').forEach(star => {
          star.addEventListener('click', async () => {
            if (!token) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°.');
            const value = parseInt(star.dataset.value);
            const res = await fetch(`${BASE_URL}/api/celebs/${celebId}/rate`, {
              method: 'POST',
              headers: {
                Authorization: 'Bearer ' + token,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ rating: value })
            });
            const result = await res.json();
            if (res.ok) {
              alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
              location.reload();
            } else {
              alert(result.message || 'Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°.');
            }
          });
        });
      }

      // Y√™u th√≠ch
      let isFav = false;
      try {
        const favRes = await fetch(`${BASE_URL}/api/users/favorites`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        const favs = await favRes.json();
        isFav = favs.some(c => c._id === celebId);
      } catch {}

      const favBtn = document.createElement('button');
      favBtn.innerHTML = isFav ? '‚ù§Ô∏è ƒê√£ y√™u th√≠ch' : 'ü§ç Th√™m v√†o y√™u th√≠ch';
      favBtn.className = 'px-4 py-2 bg-pink-500 text-white rounded hover:bg-pink-600 hover:animate-bounce';
      favBtn.onclick = async () => {
        if (!token) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
        const res = await fetch(`${BASE_URL}/api/users/favorites/${encodeURIComponent(celebId)}`, {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token }
        });
        if (res.ok) {
          isFav = !isFav;
          favBtn.innerHTML = isFav ? '‚ù§Ô∏è ƒê√£ y√™u th√≠ch' : 'ü§ç Th√™m v√†o y√™u th√≠ch';
        } else {
          alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t y√™u th√≠ch');
        }
      };
      document.getElementById('fav-btn-container').appendChild(favBtn);
    }

    loadDetail();
  </script>
</body>
</html>
